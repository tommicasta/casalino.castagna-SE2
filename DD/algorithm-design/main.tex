\section{ALGORITHM DESIGN}

This sections present some of the main algorithms used in the application. Those algorithms are written
in a pseudocode resembling the java syntax.

\subsection{Available car search}
The following algorithm searches all the available cars near the area specified by the user, if a car
is within the visible area of the map, this function will place it on the map in the correct position
so that the user can possibly reserve it. Referring to the Google Maps API this function should be
added as a listener either to the "bounds\textunderscore changed" event and to the map generation event,
so that the user can drag the map and still see the available cars.

\begin{algorithm}
\begin{algorithmic}[1]
  \caption{\label{alg:stdreqhandler} Car Search Handling Algorithm}

  \Function{nearbyAvailableCarSearch}{}
    \State $ bounds = \textit{map.getBounds()} $
    \State $ availableCars = \Call {getAvailableCars} $
    \State $ i = \textit{0}$
    \For {$ i < \textit{availableCars.size()} $}
      \State $ currentLatLng = \textit{availableCars[i].getLatLng} $
      \State $ currentId = \textit{availableCars[i].getId} $
      \If {$ \textit{bounds.contains(currentLatLng)} $}
        \State \textit{map.addCar(
          \State position: currentLatLng,
          \State title: currentId,
          \State details: availableCars[i].getDetails
        \State )}
      \ElsIf {$ \textit{map.contains(currentId)} $}
        \State map.removeCar(currentId)
      \EndIf
      \State $ i++ $
    \EndFor
    \State \textbf{return}
  \EndFunction

\end{algorithmic}
\end{algorithm}

\pagebreak

\subsection{Car reservation}
The following algorithm takes care of the reservation of a car by a user. In order to avoid consistency
issues we need to ensure the atomicity of the reservation so that a car cannot be served by more than
one user. To do so we decided to use a lock-like pattern.


\begin{algorithm}

  \algblock[TryCatchFinally]{try}{endtry}
  \algcblock[TryCatchFinally]{TryCatchFinally}{finally}{endtry}
  \algcblockdefx[TryCatchFinally]{TryCatchFinally}{catch}{endtry}
  	[1]{\textbf{catch} #1}
  	{\textbf{end try}}

\begin{algorithmic}[1]
  \caption{\label{alg:stdreqhandler} Car Reservation Handling Algorithm}

  \Function{carReservation}{CarId id, User user}
    \State $ lock = null $
    \State $ car = null $
    \try
      \State $ lock = getCarLock(id) $
      \State $ availableCars = $ \Call {getAvailableCars}{$ $}
      \State $ car = availableCars.getCar(id) $
      \State $ car.reserveCar() $
      \State $ currentReservations =  $ \Call {getCurrentReservations}{$ $}
      \If {$ currentReservations.contains(user) $}
        \State {\textbf{Throw} multipleReservationException}
      \EndIf
      \State $ reservationTimer = Timer(60) $
      \State $ reservationTimer.start() $
      \State \Call {createReservation}{id, user, reservationTimer}{$ $}
    \catch {(LockedResourceException)}
      \State {\textbf{return} ReservationError}
    \catch{(CarNotFoundException)}
      \State $ lock.releaseLock() $
      \State {\textbf{return} ReservationError}
    \catch{(multipleReservationException)}
      \State $ lock.releaseLock() $
      \State $ car.setAvailable() $
      \State {\textbf{return} ReservationError}
    \endtry
    \State \textbf{return}
  \EndFunction

\end{algorithmic}
\end{algorithm}

\pagebreak
